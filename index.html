<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryPath - AI-Powered Interactive Fiction</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="css/main.css?v=83">
    <link rel="stylesheet" href="css/wizard.css?v=83">
    <link rel="stylesheet" href="css/books.css?v=83">
    <script src="js/i18n.js?v=83"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/CustomEase.min.js"></script>
</head>
<body>
    <!-- Language Selector -->
    <div class="lang-selector">
        <button class="lang-pill active" data-lang="en" onclick="switchLanguage('en')">
            EN
        </button>
        <button class="lang-pill" data-lang="ja" onclick="switchLanguage('ja')">
            Êó•Êú¨Ë™û
        </button>
    </div>

    <!-- Splash Page -->
    <div class="splash-page" id="splash">
        <!-- Decorative Header -->
        <div class="page-decoration top">
            <span class="deco-star">‚≠ê</span>
            <span class="deco-star">‚ú®</span>
            <span class="deco-star">üåü</span>
        </div>

        <!-- Hero Section -->
        <header class="hero">
            <h1 class="hero-title">
                <span class="title-icon">üìñ</span>
                <span data-i18n="splash.title">StoryPath</span>
                <span class="title-icon">‚ú®</span>
            </h1>
            <p class="hero-subtitle" data-i18n="splash.subtitle">
                Where every choice writes your tale!
            </p>
            <div class="hero-decoration">
                ~ üé≠ <span data-i18n="splash.tagline">Choose Your Adventure</span> üé≠ ~
            </div>
        </header>

        <!-- Story Library -->
        <section class="story-library">
            <h2 class="section-title">
                üìö <span data-i18n="splash.yourStories">Your Story Collection</span>
            </h2>

            <div class="books-shelf-wrapper">
                <!-- New Story Card (first position) -->
                <div class="books__item new-story-book" onclick="startNewStory()">
                    <div class="books__container">
                        <div class="books__cover">
                            <div class="books__back-cover"></div>
                            <div class="books__inside">
                                <div class="books__page"></div>
                                <div class="books__page"></div>
                                <div class="books__page"></div>
                            </div>
                            <div class="books__image new-story-cover" id="newStoryCover">
                                <img class="rotating-cover active" src="/storypath/images/new-story-covers/cover-1.png" alt="New Story">
                                <img class="rotating-cover" src="/storypath/images/new-story-covers/cover-2.png" alt="New Story">
                                <img class="rotating-cover" src="/storypath/images/new-story-covers/cover-3.png" alt="New Story">
                                <img class="rotating-cover" src="/storypath/images/new-story-covers/cover-4.png" alt="New Story">
                                <img class="rotating-cover" src="/storypath/images/new-story-covers/cover-5.png" alt="New Story">
                                <img class="rotating-cover" src="/storypath/images/new-story-covers/cover-6.png" alt="New Story">
                                <div class="books__effect"></div>
                                <div class="books__light"></div>
                            </div>
                            <div class="books__hitbox"></div>
                        </div>
                    </div>
                    <div class="books__title">
                        <span data-i18n="splash.newStory">Begin a New Adventure!</span>
                    </div>
                </div>

                <!-- Story books will be loaded here -->
                <div id="booksContainer"></div>
            </div>
        </section>
    </div>

    <!-- Password Modal (hidden by default) -->
    <div class="modal" id="passwordModal" style="display: none;">
        <div class="modal-content">
            <h2>üîí <span id="modalStoryTitle"></span></h2>
            <p data-i18n="modal.passwordPrompt">This story is password protected</p>
            <input
                type="password"
                id="passwordInput"
                data-i18n-placeholder="modal.passwordPlaceholder"
                placeholder="Enter password">
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="unlockStory()">
                    <span data-i18n="modal.unlock">Unlock</span>
                </button>
                <button class="btn" onclick="closeModal()">
                    <span data-i18n="modal.cancel">Cancel</span>
                </button>
            </div>
            <p class="error-message" id="passwordError" style="display: none; color: var(--color-danger);"></p>
        </div>
    </div>

    <script>
        const API_URL = `${window.location.protocol}//${window.location.hostname}/storypath-api`;
        let currentStoryToUnlock = null;

        // Load stories on page load
        async function loadStories() {
            try {
                const response = await fetch(`${API_URL}/stories`);
                const data = await response.json();

                const container = document.getElementById('booksContainer');
                container.innerHTML = '';

                // Add story books
                data.stories.forEach((story) => {
                    const book = create3DBook(story);
                    container.appendChild(book);
                });

                // Initialize GSAP animations for all books
                setTimeout(() => init3DBookAnimations(), 100);
            } catch (error) {
                console.error('Failed to load stories:', error);
            }
        }

        // Parse furigana for titles
        function parseFurigana(text) {
            if (!text) return text;
            return text.replace(/([‰∏Ä-ÈæØ„ÄÖ]+)„Ää([„ÅÅ-„Çì]+)„Äã/g, '<ruby>$1<rt>$2</rt></ruby>');
        }

        function create3DBook(story) {
            const bookDiv = document.createElement('div');
            bookDiv.className = 'books__item';
            bookDiv.setAttribute('data-story-id', story.id);

            // Get cover URL or use placeholder
            const coverUrl = story.book_cover_url || `/storypath/images/placeholder-${story.genre}-cover.png`;
            const hasRealCover = story.book_cover_url && !story.book_cover_url.includes('placeholder');

            bookDiv.innerHTML = `
                <div class="books__container">
                    <div class="books__cover">
                        <div class="books__back-cover"></div>
                        <div class="books__inside">
                            <div class="books__page"></div>
                            <div class="books__page"></div>
                            <div class="books__page"></div>
                        </div>
                        <div class="books__image ${story.is_password_protected ? 'book-locked' : ''} ${!hasRealCover ? 'book-placeholder-' + story.genre : ''}">
                            ${hasRealCover ? `<img src="${coverUrl}" alt="${story.title}" onerror="this.style.display='none'; this.parentElement.classList.add('book-placeholder-${story.genre}');">` : ''}
                            <div class="books__effect"></div>
                            <div class="books__light"></div>
                        </div>
                        <div class="books__hitbox" data-book-id="${story.id}"></div>
                    </div>
                </div>
                <div class="books__title">
                    ${parseFurigana(story.title)}${story.is_password_protected ? ' üîí' : ''}
                </div>
            `;

            return bookDiv;
        }

        // Initialize GSAP 3D book animations
        function init3DBookAnimations() {
            if (typeof gsap === 'undefined') {
                console.error('GSAP not loaded');
                return;
            }

            gsap.registerPlugin(CustomEase);
            CustomEase.create("bookEase", "0.25, 1, 0.5, 1");

            const books = document.querySelectorAll(".books__item");
            books.forEach((book) => {
                const hitbox = book.querySelector(".books__hitbox");
                const bookImage = book.querySelector(".books__image");
                const bookEffect = book.querySelector(".books__effect");
                const pages = book.querySelectorAll(".books__page");
                const bookLight = book.querySelector(".books__light");

                // Set initial state
                gsap.set(bookImage, {
                    boxShadow: "0 10px 20px rgba(0,0,0,0.15), 0 30px 45px rgba(0,0,0,0.12), 0 60px 80px rgba(0,0,0,0.1)"
                });
                gsap.set(bookLight, { opacity: 0.1, rotateY: 0 });
                gsap.set(pages, { x: 0 });

                // Create hover timeline
                const hoverIn = gsap.timeline({ paused: true });

                hoverIn.to(bookImage, {
                    duration: 0.7,
                    rotateY: -12,
                    translateX: -6,
                    scaleX: 0.96,
                    boxShadow: "10px 10px 20px rgba(0,0,0,0.25), 20px 20px 40px rgba(0,0,0,0.2), 40px 40px 60px rgba(0,0,0,0.15)",
                    ease: "bookEase"
                }, 0);

                hoverIn.to(bookEffect, {
                    duration: 0.7,
                    marginLeft: 10,
                    ease: "bookEase"
                }, 0);

                hoverIn.to(bookLight, {
                    duration: 0.7,
                    opacity: 0.2,
                    rotateY: -12,
                    ease: "bookEase"
                }, 0);

                if (pages.length) {
                    hoverIn.to(pages[0], { x: "4px", duration: 0.7, ease: "power1.inOut" }, 0);
                    hoverIn.to(pages[1], { x: "2px", duration: 0.7, ease: "power1.inOut" }, 0);
                    hoverIn.to(pages[2], { x: "0px", duration: 0.7, ease: "power1.inOut" }, 0);
                }

                // Hover events
                hitbox.addEventListener("mouseenter", () => hoverIn.play());
                hitbox.addEventListener("mouseleave", () => hoverIn.reverse());

                // Click event
                hitbox.addEventListener("click", () => {
                    const storyId = hitbox.getAttribute('data-book-id');
                    if (storyId) {
                        const story = { id: storyId, is_password_protected: book.querySelector('.book-locked') !== null };
                        if (story.is_password_protected) {
                            // Get full story data for password modal
                            fetch(`${API_URL}/stories`)
                                .then(r => r.json())
                                .then(data => {
                                    const fullStory = data.stories.find(s => s.id === storyId);
                                    if (fullStory) showPasswordModal(fullStory);
                                });
                        } else {
                            loadStory(storyId);
                        }
                    }
                });
            });
        }

        function formatTimeAgo(dateString) {
            // SQLite stores UTC timestamps without 'Z', so add it
            const dateStr = dateString.includes('Z') ? dateString : dateString + 'Z';
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);

            if (diffHours < 1) return 'just now';
            if (diffHours < 24) return `${diffHours}h ${t('splash.ago')}`;
            return `${diffDays}d ${t('splash.ago')}`;
        }

        function showPasswordModal(story) {
            currentStoryToUnlock = story;
            document.getElementById('modalStoryTitle').textContent = story.title;
            document.getElementById('passwordModal').style.display = 'flex';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordError').style.display = 'none';
            document.getElementById('passwordInput').focus();
        }

        function closeModal() {
            document.getElementById('passwordModal').style.display = 'none';
            currentStoryToUnlock = null;
        }

        async function unlockStory() {
            const password = document.getElementById('passwordInput').value;

            try {
                const response = await fetch(`${API_URL}/story/unlock`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        story_id: currentStoryToUnlock.id,
                        password
                    })
                });

                const data = await response.json();

                if (data.success) {
                    localStorage.setItem(`story_token_${currentStoryToUnlock.id}`, data.token);
                    closeModal();
                    loadStory(currentStoryToUnlock.id);
                } else {
                    document.getElementById('passwordError').textContent = t('modal.invalidPassword');
                    document.getElementById('passwordError').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to unlock story:', error);
                document.getElementById('passwordError').textContent = 'Error unlocking story';
                document.getElementById('passwordError').style.display = 'block';
            }
        }

        function startNewStory() {
            window.location.href = 'wizard.html';
        }

        function loadStory(storyId) {
            window.location.href = `game.html?story=${storyId}`;
        }

        function switchLanguage(lang) {
            setLanguage(lang);

            // Update active button
            document.querySelectorAll('.lang-pill').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-lang') === lang);
            });

            // Reload stories to update time formatting
            loadStories();
        }

        // Enter key for password modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && document.getElementById('passwordModal').style.display !== 'none') {
                unlockStory();
            }
        });

        // Rotate "Create New" book covers
        function startCoverRotation() {
            const covers = document.querySelectorAll('.rotating-cover');
            if (covers.length === 0) return;

            let currentIndex = 0;

            setInterval(() => {
                covers[currentIndex].classList.remove('active');
                currentIndex = (currentIndex + 1) % covers.length;
                covers[currentIndex].classList.add('active');
            }, 4000); // Change cover every 4 seconds
        }

        // Load stories on page load
        window.addEventListener('load', () => {
            loadStories();
            startCoverRotation();
        });
    </script>
</body>
</html>
